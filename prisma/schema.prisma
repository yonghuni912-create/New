generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 사용자 & 인증
model User {
  id            String         @id @default(cuid())
  email         String         @unique
  password      String
  name          String
  role          String         @default("VIEWER")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  assignedTasks Task[]         @relation("TaskAssignee")
  notifications Notification[]
  taskComments  TaskComment[]
  auditLogs     AuditLog[]
}

// 국가 설정
model Country {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  region    String?
  currency  String?
  timezone  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  stores    Store[]
  fxRates   FXRate[]
}

// 환율
model FXRate {
  id            String   @id @default(cuid())
  countryId     String
  fromCurrency  String
  toCurrency    String
  rate          Float
  effectiveDate DateTime
  createdAt     DateTime @default(now())
  country       Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
}

// 매장
model Store {
  id                String    @id @default(cuid())
  storeCode         String    @unique
  storeName         String
  countryId         String
  country           String    @default("CA")
  address           String?
  city              String?
  state             String?
  postalCode        String?
  latitude          Float?
  longitude         Float?
  franchiseeEmail   String?
  franchiseeName    String?
  franchiseePhone   String?
  status            String    @default("PLANNING")
  plannedOpenDate   DateTime?
  actualOpenDate    DateTime?
  estimatedRevenue  Float?
  initialInvestment Float?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  countryRef        Country   @relation(fields: [countryId], references: [id])
  tasks             Task[]
  files             StoreFile[]
}

// 템플릿
model Template {
  id          String          @id @default(cuid())
  name        String          @unique
  description String?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  phases      TemplatePhase[]
}

model TemplatePhase {
  id           String         @id @default(cuid())
  templateId   String
  name         String
  description  String?
  orderIndex   Int
  durationDays Int            @default(7)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  template     Template       @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tasks        TemplateTask[]
  storeTasks   Task[]
}

model TemplateTask {
  id                  String        @id @default(cuid())
  phaseId             String
  title               String
  description         String?
  orderIndex          Int
  defaultDurationDays Int           @default(1)
  priority            String        @default("MEDIUM")
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  phase               TemplatePhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  tasks               Task[]
}

// 태스크
model Task {
  id              String           @id @default(cuid())
  storeId         String
  phaseId         String?
  templateTaskId  String?
  title           String
  description     String?
  status          String           @default("TODO")
  priority        String           @default("MEDIUM")
  assigneeId      String?
  dueDate         DateTime?
  completedAt     DateTime?
  orderIndex      Int              @default(0)
  blockedReason   String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  store           Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  phase           TemplatePhase?   @relation(fields: [phaseId], references: [id])
  templateTask    TemplateTask?    @relation(fields: [templateTaskId], references: [id])
  assignee        User?            @relation("TaskAssignee", fields: [assigneeId], references: [id])
  dependencies    TaskDependency[] @relation("DependentTask")
  dependents      TaskDependency[] @relation("DependencyTask")
  comments        TaskComment[]
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TaskDependency {
  id          String   @id @default(cuid())
  taskId      String
  dependsOnId String
  createdAt   DateTime @default(now())
  task        Task     @relation("DependentTask", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOn   Task     @relation("DependencyTask", fields: [dependsOnId], references: [id], onDelete: Cascade)
}

// 파일
model StoreFile {
  id           String   @id @default(cuid())
  storeId      String
  fileName     String
  originalName String
  mimeType     String
  size         Int
  path         String
  category     String?
  description  String?
  uploadedById String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  store        Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

// 감사 로그
model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String
  oldValue   String?
  newValue   String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])
}

// 알림
model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  linkUrl   String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// 식재료 마스터 (가격 없이 기본 정보만)
model IngredientMaster {
  id           String                   @id @default(cuid())
  category     String
  koreanName   String
  englishName  String
  quantity     Float                    @default(0)
  unit         String
  yieldRate    Float                    @default(100)
  imageUrl     String?                  // 제품 이미지 URL
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt
  manualIngredients ManualIngredient[]  @relation("MasterToManualIngredient")
  inventoryItems    InventoryItem[]     @relation("IngredientToInventory")
  priceItems        PriceTemplateItem[] @relation("MasterToPriceItem")
}

// 가격 템플릿 (국가/지역별)
model PriceTemplate {
  id           String              @id @default(cuid())
  name         String              @unique
  country      String
  region       String?
  currency     String              @default("CAD")
  description  String?
  isActive     Boolean             @default(true)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  items        PriceTemplateItem[]
  manuals      MenuManual[]        @relation("TemplateTomanual")
}

// 가격 템플릿 아이템 (템플릿 내 각 식재료별 가격)
// 국가별로 다른 제품을 사용할 수 있으므로 localXxx 필드로 국가별 독자 정보 저장
model PriceTemplateItem {
  id                 String           @id @default(cuid())
  priceTemplateId    String
  ingredientMasterId String
  unitPrice          Float            @default(0)
  packagingUnit      String?
  packagingQty       Float?
  notes              String?
  // 국가별 독자 필드 (null이면 마스터 값 사용)
  localEnglishName   String?
  localKoreanName    String?
  localQuantity      Float?
  localUnit          String?
  localYieldRate     Float?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  priceTemplate      PriceTemplate    @relation(fields: [priceTemplateId], references: [id], onDelete: Cascade)
  ingredientMaster   IngredientMaster @relation("MasterToPriceItem", fields: [ingredientMasterId], references: [id], onDelete: Cascade)
  
  @@unique([priceTemplateId, ingredientMasterId])
}

// 메뉴 매뉴얼
model MenuManual {
  id              String             @id @default(cuid())
  name            String
  koreanName      String?
  imageUrl        String?
  shelfLife       String?
  yield           Float?
  yieldUnit       String?
  sellingPrice    Float?
  notes           String?
  cookingMethod   String?
  isActive        Boolean            @default(true)
  isArchived      Boolean            @default(false)
  deletedAt       DateTime?
  deletedBy       String?
  groupId         String?
  priceTemplateId String?
  // 마스터/복제본 관계 필드
  isMaster        Boolean            @default(true)   // true = 마스터, false = 국가 복제본
  masterManualId  String?                             // 복제본일 경우 원본 마스터 ID
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  ingredients     ManualIngredient[]
  posMenuLinks    PosMenuLink[]      @relation("ManualToPosLink")
  priceTemplate   PriceTemplate?     @relation("TemplateTomanual", fields: [priceTemplateId], references: [id], onDelete: SetNull)
  // Self-relation for master/copy
  masterManual    MenuManual?        @relation("ManualCopies", fields: [masterManualId], references: [id], onDelete: SetNull)
  copies          MenuManual[]       @relation("ManualCopies")
}

// 매뉴얼 재료
model ManualIngredient {
  id               String            @id @default(cuid())
  manualId         String
  ingredientId     String?
  name             String
  koreanName       String?
  quantity         Float
  unit             String
  section          String            @default("MAIN")
  sortOrder        Int               @default(0)
  notes            String?
  // 원가 계산용 필드
  unitPrice        Float?            // pricing 템플릿의 가격
  baseQuantity     Float?            // pricing 템플릿의 기준 수량
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  manual           MenuManual        @relation(fields: [manualId], references: [id], onDelete: Cascade)
  ingredientMaster IngredientMaster? @relation("MasterToManualIngredient", fields: [ingredientId], references: [id], onDelete: SetNull)
}

// 재고 관리
model InventoryGroup {
  id        String            @id @default(cuid())
  name      String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  periods   InventoryPeriod[]
  posLinks  PosMenuLink[]
}

model InventoryPeriod {
  id        String          @id @default(cuid())
  groupId   String
  startDate DateTime
  endDate   DateTime
  status    String
  notes     String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  group     InventoryGroup  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  items     InventoryItem[]
  sales     PeriodSales[]
}

model InventoryItem {
  id                  String           @id @default(cuid())
  inventoryPeriodId   String
  ingredientMasterId  String
  openingStock        Float
  stockIn             Float            @default(0)
  wastage             Float            @default(0)
  actualClosingStock  Float
  totalUsage          Float?
  theoreticalUsage    Float?
  variance            Float?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  period              InventoryPeriod  @relation(fields: [inventoryPeriodId], references: [id], onDelete: Cascade)
  ingredient          IngredientMaster @relation("IngredientToInventory", fields: [ingredientMasterId], references: [id], onDelete: Cascade)
}

model PosMenuLink {
  id           String         @id @default(cuid())
  groupId      String
  posMenuName  String
  menuManualId String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  group        InventoryGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  manual       MenuManual     @relation("ManualToPosLink", fields: [menuManualId], references: [id], onDelete: Cascade)
  sales        PeriodSales[]
  
  @@unique([groupId, posMenuName])
}

model PeriodSales {
  id                String          @id @default(cuid())
  inventoryPeriodId String
  posMenuLinkId     String
  quantitySold      Int
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  period            InventoryPeriod @relation(fields: [inventoryPeriodId], references: [id], onDelete: Cascade)
  posLink           PosMenuLink     @relation(fields: [posMenuLinkId], references: [id], onDelete: Cascade)
  
  @@unique([inventoryPeriodId, posMenuLinkId])
}